---
title: "Journal (reproducible report)"
author: "Nijat Gasimov"
date: "2020-12-04"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    toc_depth: 3
    #code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```



# Chapter 2

## Challenge 1

Code for the first Challenge, sales by state are given below.

### Loading libraries

```{r}
library(tidyverse)
library(readxl)
library(lubridate)
```

### Importing Excel data

```{r}
bikes_c1_tbl <- read_excel(path = "data-science/00_data/01_bike_sales/01_raw_data/bikes.xlsx")
orderlines_c1_tbl <- read_excel(path = "data-science/00_data/01_bike_sales/01_raw_data/orderlines.xlsx")
bikeshops_c1_tbl  <- read_excel(path = "data-science/00_data/01_bike_sales/01_raw_data/bikeshops.xlsx")
```

### Joining data

```{r}
left_join(orderlines_c1_tbl, bikes_c1_tbl, by = c("product.id" = "bike.id"))


bike_orderlines_joined_c1_tbl <- orderlines_c1_tbl %>%
  left_join(bikes_c1_tbl, by = c("product.id" = "bike.id")) %>%
  left_join(bikeshops_c1_tbl, by = c("customer.id" = "bikeshop.id"))
```

### Wrangling data

Create new data in which you wrangle combined data:

```{r}
bike_orderlines_wrangled_c1_tbl <- bike_orderlines_joined_c1_tbl %>%
  
  #separating into city and state categories
  separate(col    = location,
           into   = c("city", "state"),
           sep    = ", ") %>%
  
  #add new column to show total price  
  mutate(total.price = price * quantity) %>%
  
  #erase unneeded columns    
  select(-...1, -gender, -url, -lat, -lng, -frame.material, -weight)
```

### Take out needed data

```{r}
sales_by_state_c1_tbl <- bike_orderlines_wrangled_c1_tbl %>%
  select(state, total.price) %>% #select the columns you'll use
  group_by(state) %>% #group the rows based on common states
  summarize(sales = sum(total.price)) %>% #sum up the sales by state
  mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                     decimal.mark = ",", 
                                     prefix = "", 
                                     suffix = " €")) #turn the numbers to money format
```

### Plot the graph

```{r plot, fig.width=10, fig.height=7}
sales_by_state_c1_tbl %>%
  
  # Setup canvas with the columns state (x-axis) and sales (y-axis)
  ggplot(aes(x = state, y = sales)) + 
  geom_col(fill = "#2DC6D6") + # Use geom_col for a bar plot
  geom_label(aes(label = sales_text)) + # Adding labels to the bars
  scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                    decimal.mark = ",", 
                                                    prefix = "", 
                                                    suffix = " €")) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) #rotate the x-axis

```





## Challenge 2

We will continue building on the previous code, so some steps are not needed to be repeated again.

### Manipulate data for new graph

```{r}
sales_by_state_and_year_c1_tbl <- bike_orderlines_wrangled_c1_tbl %>% #create new data for visualization
  select(order.date, total.price, state) %>% #take out needed column from for the new data
  mutate(year = year(order.date)) %>% #add a year column using lubridate
  group_by(year, state) %>%
  summarise(sales = sum(total.price)) %>%
  ungroup() %>%
  
  mutate(sales_text = scales::dollar(sales, big.mark = ".", 
                                     decimal.mark = ",", 
                                     prefix = "", 
                                     suffix = " €")) #formatting the money
```

### Visualizing the data

```{r}

sales_by_state_and_year_c1_tbl %>%
  ggplot(aes(x = year, y = sales, fill = state))+ #create the plot
  geom_col() +  #define plot type
  facet_wrap(~ state)+  #to form a different plot for each state
  scale_y_continuous(labels = scales::dollar_format(big.mark = ".", 
                                                  decimal.mark = ",", 
                                                  prefix = "", 
                                                  suffix = " €")) #formatting
  #theme(axis.text.x = element_text(angle = 70, hjust = 1)) #rotate the x-axis label
```

# Chapter 3

## Challenge 3


For this task, I will access to Deezer (music streaming platform) API and extract my Retro music playlist which I created in 2014.

### Load the libraries

```{r}
library(httr)
library(tidyverse)
library(jsonlite)
library(purrr)
```


### Make request from API

```{r}
resp <- GET("https://api.deezer.com/playlist/1000960231")
resp_content <- content(resp, as = "parsed")
```


### Wrangle data

```{r}
a <- resp_content[["tracks"]][["data"]] #Extract the list containing song information

#Extract song titles from the list
Titels <- a %>%
  map(purrr::pluck,"title") %>% 
  as_tibble("titel") %>% #save as tibble
  t() #list is given in rows, transverse it to column
  
#Extract album names from the list
Albums <- a %>%
  map(purrr::pluck, "album") %>%
  map(purrr::pluck, "title") %>%
  as_tibble("Album") %>%
  t()

#Extract the artist names from the list
Artists <- a %>%
  map(purrr::pluck, "artist") %>%
  map(purrr::pluck, "name") %>%
  as_tibble("Artist") %>%
  t()

#Extract links to individual songs
Links <- a %>%
  map(purrr::pluck, "link") %>%
  as_tibble("Link") %>%
  t()
   
#Finally, bind columns into a table and name them
Playlist <- bind_cols("Song"=Titels, "Album"= Albums, "Artist"=Artists, "Link"=Links)
```

### Data

```{r}
Playlist
```



## Challenge 4


```{r}
#1 Loading libraries
  
library(tidyverse) # Main Package - Loads dplyr, purrr, etc.
library(rvest)     # HTML Hacking & Web Scraping
library(xopen)     # Quickly opening URLs
library(jsonlite)  # converts JSON files to R objects
library(glue)      # concatenate strings
library(stringi)   # character string/text processing
library(RSQLite)   # working with databases

# 2. Open category page 

# Arbitrarily chosen E-bike family, Mountainbike category

url_homepage <- "https://www.radon-bikes.de/e-bike/mountainbike/bikegrid/"
#xopen(url_homepage)
html_homepage <- read_html(url_homepage)


# 3. Scrape website

#Extract the product ID names
product_id_tbl <- html_homepage %>%
  html_nodes(css = ".m-bikegrid__info .a-heading--small") %>%
  html_text() %>%
  trimws("both") %>% # erase empty space
  enframe(name = "position", value = "product_id") #vector to tibble

#Extract the product prices
product_prices_tbl <- html_homepage %>%
  html_nodes(css = ".currency_eur> .m-bikegrid__price--active") %>%
  html_text("span") %>% # extract span attribute
  enframe(name = "position", value = "product_prices") #vector to tibble

#Bind two columns
mountainbike_list_tbl <- product_id_tbl %>%
  bind_cols(product_prices_tbl %>% select("product_prices"))

# 4. Creating database

# Create database
con <- RSQLite::dbConnect(drv    = SQLite(), 
                           dbname = "data-science/00_data/Mountain_bikes.sqlite")
# Add tables to database
dbWriteTable(con, "product_id", product_id_tbl, overwrite=TRUE)
dbWriteTable(con, "product_prices", product_prices_tbl, overwrite=TRUE)

# 5. Call database

# Return the name of tables
dbListTables(con)

# Return any data you need
tbl(con, "product_id")

tbl(con, "product_prices")


# Disconnect from database after use
dbDisconnect(con)
con
```





**IMPORTANT:** You can delete everything in here and start fresh. You might want to start by not deleting anything above this line until you know what that stuff is doing.

This is an `.Rmd` file. It is plain text with special features. Any time you write just like this, it will be compiled to normal text in the website. If you put a \# in front of your text, it will create a top level-header.

# My first post

Last compiled: `r Sys.Date()`

Notice that whatever you define as a top level header, automatically gets put into the table of contents bar on the left. 

## Second level header

You can add more headers by adding more hashtags. These won't be put into the table of contents

### third level header

Here's an even lower level header

# My second post (note the order)

Last compiled: `r Sys.Date()`

I'm writing this tutorial going from the top down. And, this is how it will be printed. So, notice the second post is second in the list. If you want your most recent post to be at the top, then make a new post starting at the top. If you want the oldest first, do, then keep adding to the bottom

# Adding R stuff

So far this is just a blog where you can write in plain text and serve your writing to a webpage. One of the main purposes of this lab journal is to record your progress learning R. The reason I am asking you to use this process is because you can both make a website, and a lab journal, and learn R all in R-studio. This makes everything really convenient and in the same place. 

So, let's say you are learning how to make a histogram in R. For example, maybe you want to sample 100 numbers from a normal distribution with mean = 0, and standard deviation = 1, and then you want to plot a histogram. You can do this right here by using an r code block, like this:

```{r}
samples <- rnorm(100, mean=0, sd=1)
hist(samples)
```

When you knit this R Markdown document, you will see that the histogram is printed to the page, along with the R code. This document can be set up to hide the R code in the webpage, just delete the comment (hashtag) from the cold folding option in the yaml header up top. For purposes of letting yourself see the code, and me see the code, best to keep it the way that it is. You'll learn that all of these things and more can be customized in each R code block.